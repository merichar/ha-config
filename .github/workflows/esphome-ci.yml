name: "ESPHome: Validate & Compile"

on:
  push:
    branches: [main]
    paths: ['esphome/**']
  pull_request:
    branches: [main]
    paths: ['esphome/**']

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: esphome
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4

      - name: Install ESPHome
        run: uv tool install esphome

      - name: Merge CI secrets
        run: find ci/secrets -name '*.yaml' | sort | xargs cat > secrets.yaml

      - name: Validate configs
        run: |
          exit_code=0
          for file in *.yaml; do
            [ "$file" = "secrets.yaml" ] && continue
            echo "::group::Validating $file"
            if ! esphome config "$file"; then
              exit_code=1
            fi
            echo "::endgroup::"
          done
          exit $exit_code

  compile:
    name: Compile
    needs: validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: esphome
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4

      - name: Install ESPHome
        run: uv tool install esphome

      - name: Merge CI secrets
        run: find ci/secrets -name '*.yaml' | sort | xargs cat > secrets.yaml

      - name: Compile configs
        run: |
          exit_code=0
          for file in *.yaml; do
            [ "$file" = "secrets.yaml" ] && continue
            echo "::group::Compiling $file"
            if ! esphome compile "$file"; then
              exit_code=1
            fi
            echo "::endgroup::"
          done
          exit $exit_code
